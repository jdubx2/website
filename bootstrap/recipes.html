<!DOCTYPE html>
<html lang="en">

  <head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Jesse Weiss</title>

    <!-- Bootstrap core CSS -->
    <!-- <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet"> -->
    <link href="vendor/bootstrap/css/bootstrap.css" rel="stylesheet">

    <link href="css/3-col-portfolio.css" rel="stylesheet">

    <link href='css/mdb.css' rel='stylesheet'>
    <link href='css/os.css' rel='stylesheet'>

    <link rel="shortcut icon" type="image/png" href="img/favicon.png"/>

  </head>

  <body>

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
      <div class="container"> <img class ='navlogo' src ='img/logo.png' alt="", height = '55', width = '55'>
        <a class="navbar-brand" href="index.html">jesseweiss.me</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarResponsive">
          <ul class="navbar-nav ml-auto">
            <!-- <li class="nav-item active">
              <a class="nav-link" href="#">Home
                <span class="sr-only">(current)</span>
              </a>
            </li> -->
            <li class="nav-item">
              <a href='index.html'><div class = 'nav-icon'><svg class = 'nav-icon-svg' xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24"><path stroke='none' fill='#f5f5f5' d="M12 9.185l7 6.514v6.301h-14v-6.301l7-6.514zm0-2.732l-9 8.375v9.172h18v-9.172l-9-8.375zm2 14.547h-4v-6h4v6zm10-8.852l-1.361 1.465-10.639-9.883-10.639 9.868-1.361-1.465 12-11.133 12 11.148z"/></svg>
              </div></a>
            </li>
            <li class="nav-item">
              <a href='resume.html'><div class = 'nav-icon'><svg class = 'nav-icon-svg' xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24"><path stroke="none" fill="#f5f5f5" d="M4 22v-20h16v11.543c0 4.107-6 2.457-6 2.457s1.518 6-2.638 6h-7.362zm18-7.614v-14.386h-20v24h10.189c3.163 0 9.811-7.223 9.811-9.614zm-5-1.386h-8v-1h8v1zm0-4h-8v1h8v-1zm0-3h-8v1h8v-1zm-9 0h-1v1h1v-1zm0 3h-1v1h1v-1zm0 3h-1v1h1v-1z"/></svg>
              </div></a>
            </li>
            <li class="nav-item">
              <a href='https://www.linkedin.com/in/jesse-w-weiss/' target="_blank"><div class = 'nav-icon'><svg class = 'nav-icon-svg-li' xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24"><path stroke="none" fill="#f5f5f5" d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/></svg>
              </div></a>
            </li>
            <li class="nav-item">
              <a href='https://github.com/jdubx2' target="_blank"><div class = 'nav-icon'><svg class = 'nav-icon-svg-gh' xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24"><path stroke="none" fill="#f5f5f5" d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
              </div></a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Page Content -->
    <div class='lax'>
    <div class="container">
      <!-- Page Heading -->
      <div class = 'banner-space'></div>
        <div class = 'text-input-box'>
          <h1 class='article_h1'><b>Ingredient Networks</b>
            <a style = 'float:right;' href='https://github.com/jdubx2/ingredient_network' target="_blank"><div class = 'nav-icon'><svg class = 'nav-icon-svg-gh' xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24"><path stroke="none" fill="black" d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
            </div></a>
          <br /><span class = 'sub_span'>Analyzing a corpus of 30k+ beer recipes</span></h1>
          <div class='customHr'>a</div>
          <h2><b>Preface</b></h2>
          <p>If you're a fan of beer, you know that there are a wide variety of styles to choose from. You also may know that there are thousands of different ingredients that can go into these styles, each producing distinct colors, bodies and flavors.
            There are multiple tools that hombrewers use to manage their recipes and one of the most prominent is BeerSmith. BeerSmith's online recipe database has over 34K recipes that contain detailed information on beer characteristics and ingredients used.
            As an amateur homebrewer and professional fan of beer, I thought it would be interesting to collect these recipe details and learn about the prefrences of BeerSmith's homebrewer community.</p>
          <h2><b>Building a Scraper</b></h2>
          <p>BeerSmith has a "recipes by style" webpage that I will use as the jumping off point for my scraper. Since all of the links to style pages on this page follow a specific pattern, the below function uses the findAll method from python's
            beautifulsoup package and a simple regex search to seek them out and return them as a list.</p>
        </div>
          <div class='code-chunk'>
<pre style="background:#211e1e;color:#f8f8f8"><span style="color:#e28964">from</span> bs4 <span style="color:#e28964">import</span> BeautifulSoup
<span style="color:#e28964">from</span> urllib.request <span style="color:#e28964">import</span> urlopen,Request
<span style="color:#e28964">import</span> re

<span style="color:#99cf50">def</span> <span style="color:#89bdff">scrapeStyleUrls</span>(<span style="color:#3e87e3">url</span>):
    <span style="color:#e28964">try</span>:
        url <span style="color:#e28964">=</span> Request(url, <span style="color:#3e87e3">headers</span><span style="color:#e28964">=</span>{<span style="color:#65b042">'User-Agent'</span> : <span style="color:#65b042">"Magic Browser"</span>})
        html <span style="color:#e28964">=</span> urlopen(url)
    <span style="color:#e28964">except</span> HTTPError <span style="color:#e28964">as</span> htper:
        <span style="color:#e28964">return</span> htper
    <span style="color:#e28964">except</span> URLError <span style="color:#e28964">as</span> urler:
        <span style="color:#e28964">return</span> urler
    bsObj <span style="color:#e28964">=</span> BeautifulSoup(html.read(),<span style="color:#65b042">'lxml'</span>)
    urls <span style="color:#e28964">=</span> [x[<span style="color:#65b042">"href"</span>] <span style="color:#e28964">for</span> x <span style="color:#e28964">in</span> bsObj.findAll(<span style="color:#65b042">"a"</span>,
        <span style="color:#3e87e3">href</span><span style="color:#e28964">=</span> re.compile(<span style="color:#65b042">"^(http://beersmithrecipes.com/searchrecipe\?term=).*$"</span>))]
    <span style="color:#e28964">return</span> urls
</pre>
          </div>
        <div class = 'text-input-box'>
            <p>The next piece of the scraper needs to visit the style page links collected in the previous section and search for links to the actual recipes.
              The style pages are paginated so the function uses the following recursive approach: append all recipe urls to the url list,
              search for a "next page" button, pass the next page link to the parent function, repeat until no next page button is found.
            </p>
        </div>
        <div class = 'code-chunk'>
<pre style="background:#211e1e;color:#f8f8f8"><span style="color:#99cf50">def</span> <span style="color:#89bdff">scrapeRecipeUrls</span>(<span style="color:#3e87e3">url</span>):
    <span style="color:#e28964">try</span>:
        req <span style="color:#e28964">=</span> Request(url, <span style="color:#3e87e3">headers</span><span style="color:#e28964">=</span>{<span style="color:#65b042">'User-Agent'</span> : <span style="color:#65b042">"Magic Browser"</span>})
        html <span style="color:#e28964">=</span> urlopen(req)
    <span style="color:#e28964">except</span> HTTPError <span style="color:#e28964">as</span> htper:
        <span style="color:#e28964">return</span> htper
    <span style="color:#e28964">except</span> URLError <span style="color:#e28964">as</span> urler:
        <span style="color:#e28964">return</span> urler
    <span style="color:#e28964">try</span>:
        bsObj <span style="color:#e28964">=</span> BeautifulSoup(html.read(),<span style="color:#65b042">'lxml'</span>)
        <span style="color:#e28964">for</span> x <span style="color:#e28964">in</span> bsObj.findAll(<span style="color:#65b042">"a"</span>, {<span style="color:#65b042">"title"</span>:<span style="color:#65b042">"View Recipe"</span>}):
            recipeurls.append(x[<span style="color:#65b042">"href"</span>])
    <span style="color:#e28964">except</span>:
        <span style="color:#e28964">print</span>(<span style="color:#65b042">"index failure"</span>)
    <span style="color:#e28964">try</span>:
        nxtPg <span style="color:#e28964">=</span> bsObj.find(<span style="color:#65b042">"a"</span>, <span style="color:#3e87e3">text</span> <span style="color:#e28964">=</span> <span style="color:#65b042">"Next Page >>"</span>)
        scrapeRecipeUrls(nxtPg[<span style="color:#65b042">"href"</span>])
    <span style="color:#e28964">except</span>:
        <span style="color:#e28964">print</span>(<span style="color:#65b042">"End of style - "</span><span style="color:#e28964">+</span><span style="color:#9b859d">str</span>(url))
</pre>
        </div>
        <div class = 'text-input-box'>
          <p>Now we need a function to scrape the recipe information from each of the urls collected above. A quick study of a single recipe page
            reveals that almost everything that we're looking for is contained in two tables - one with recipe information (color, bitterness, ABV etc.)
            and one with a list of ingredients. In order to reduce redundant information in the final dataset, I decided to keep this two table structure
            and utilize the recipe's ID number as a primary/foreign key. The recUrl regex function is used to extract the recipe ID and a clean version of
            the recipe name from the url itself, and the recTbl regex function is used to extract key/value pairs from the recipe info table as this table
            does not make use of headers to define it's field names. The function returns recipe information as a dictionary and recipe ingredients as a list of dictionaries.</p>
        </div>
        <div class = 'code-chunk'>
          <pre style="background:#211e1e;color:#f8f8f8">recTbl_regex <span style="color:#e28964">=</span> re.compile(
    <span style="color:#65b042"><span style="color:#99cf50">r</span>'(<span style="color:#e28964">^</span>&lt;td>&lt;b>(?P&lt;<span style="color:#89bdff">header</span>><span style="color:#ddf2a4">[<span style="color:#3387cc">A-Z</span><span style="color:#3387cc">a-z</span>]</span><span style="color:#e28964">+</span><span style="color:#ddf2a4">\s</span><span style="color:#e28964">?</span><span style="color:#ddf2a4">[<span style="color:#3387cc">A-Z</span><span style="color:#3387cc">a-z</span>]</span><span style="color:#e28964">*</span>):<span style="color:#ddf2a4">\s</span><span style="color:#e28964">?</span>&lt;/b><span style="color:#ddf2a4">\s</span><span style="color:#e28964">?</span>(?P&lt;<span style="color:#89bdff">data</span>><span style="color:#ddf2a4">[<span style="color:#e28964">^</span>&lt;]</span><span style="color:#e28964">+</span>)&lt;/td><span style="color:#e28964">$</span>)'</span>)
recUrl_regex <span style="color:#e28964">=</span> re.compile(
    <span style="color:#65b042"><span style="color:#99cf50">r</span>'(<span style="color:#e28964">^</span>http://beersmithrecipes<span style="color:#ddf2a4">.</span>com/viewrecipe/(?P&lt;<span style="color:#89bdff">recid</span>><span style="color:#ddf2a4">[<span style="color:#3387cc">0-9</span>]</span><span style="color:#e28964">+</span>)/
    (?P&lt;<span style="color:#89bdff">recname</span>><span style="color:#ddf2a4">[<span style="color:#3387cc">a-z</span><span style="color:#3387cc">0-9</span><span style="color:#3387cc">\-</span>]</span><span style="color:#e28964">+</span>))'</span>)

<span style="color:#99cf50">def</span> <span style="color:#89bdff">scrapeRecipe</span>(<span style="color:#3e87e3">url</span>):
    <span style="color:#e28964">try</span>:
        req <span style="color:#e28964">=</span> Request(url, <span style="color:#3e87e3">headers</span><span style="color:#e28964">=</span>{<span style="color:#65b042">'User-Agent'</span> : <span style="color:#65b042">"Magic Browser"</span>})
        html <span style="color:#e28964">=</span> urlopen(req)
    <span style="color:#e28964">except</span> HTTPError <span style="color:#e28964">as</span> htper:
        <span style="color:#e28964">return</span> htper
    <span style="color:#e28964">except</span> URLError <span style="color:#e28964">as</span> urler:
        <span style="color:#e28964">return</span> urler
    <span style="color:#e28964">try</span>:
        recDict <span style="color:#e28964">=</span> {}
        urlparse <span style="color:#e28964">=</span> recUrl_regex.search(<span style="color:#9b859d">str</span>(url))
        recDict[<span style="color:#65b042">'Rec_ID'</span>] <span style="color:#e28964">=</span> <span style="color:#9b859d">str</span>(urlparse.groupdict().get(<span style="color:#65b042">'recid'</span>))
        recDict[<span style="color:#65b042">'Rec_Name'</span>] <span style="color:#e28964">=</span> <span style="color:#9b859d">str</span>(urlparse.groupdict().get(<span style="color:#65b042">'recname'</span>))
        bsObj <span style="color:#e28964">=</span> BeautifulSoup(html.read(),<span style="color:#65b042">'lxml'</span>)
        recType <span style="color:#e28964">=</span> bsObj.find(<span style="color:#65b042">"h3"</span>)
        recDict[<span style="color:#65b042">'Type'</span>] <span style="color:#e28964">=</span> recType.get_text()
        recTbl <span style="color:#e28964">=</span> bsObj.find(<span style="color:#65b042">"table"</span>, {<span style="color:#65b042">"class"</span>: <span style="color:#65b042">"r_hdr"</span>}).findAll(<span style="color:#65b042">"td"</span>)
        <span style="color:#e28964">for</span> x <span style="color:#e28964">in</span> recTbl:
            tdparse <span style="color:#e28964">=</span> recTbl_regex.search(<span style="color:#9b859d">str</span>(x))
            <span style="color:#e28964">if</span> tdparse <span style="color:#e28964">is</span> <span style="color:#e28964">not</span> <span style="color:#3387cc">None</span>:
                header <span style="color:#e28964">=</span> <span style="color:#9b859d">str</span>(tdparse.groupdict().get(<span style="color:#65b042">'header'</span>))
                data <span style="color:#e28964">=</span> <span style="color:#9b859d">str</span>(tdparse.groupdict().get(<span style="color:#65b042">'data'</span>))
                recDict[header] <span style="color:#e28964">=</span> data
        ingList <span style="color:#e28964">=</span> []
        ingTbl <span style="color:#e28964">=</span> bsObj.find(<span style="color:#65b042">"table"</span>, {<span style="color:#65b042">"class"</span> : <span style="color:#65b042">"recipes"</span>}).findAll(<span style="color:#65b042">"tr"</span>)
        <span style="color:#e28964">for</span> x <span style="color:#e28964">in</span> ingTbl:
            <span style="color:#e28964">try</span>:
                ingList.append({<span style="color:#65b042">"Ingredient"</span> : x.findAll(<span style="color:#65b042">'td'</span>)[<span style="color:#3387cc">1</span>].get_text(),
                               <span style="color:#65b042">"Ing_Type"</span> : x.findAll(<span style="color:#65b042">'td'</span>)[<span style="color:#3387cc">2</span>].get_text(),
                               <span style="color:#65b042">"Rec_ID"</span> : <span style="color:#9b859d">str</span>(urlparse.groupdict().get(<span style="color:#65b042">'recid'</span>))})
            <span style="color:#e28964">except</span>:
                <span style="color:#e28964">pass</span>
        <span style="color:#e28964">return</span>(recDict, ingList)
    <span style="color:#e28964">except</span>:
        <span style="color:#e28964">print</span>(<span style="color:#65b042">"recipe error "</span><span style="color:#e28964">+</span><span style="color:#9b859d">str</span>(url))
        <span style="color:#e28964">pass</span>
</pre>
        </div>
        <div class = 'text-input-box'>
          <p>Now we're ready to scrape! After running the scrapeStyleUrls, scrapeRecipeUrls, and scrapeRecipe functions, we'll have a list of recipe dictionaries with
            recipe attributes and a list of ingredient dictionaries with ingredient attributes and recipe ID's.</p>
        </div>
        <div class = 'code-chunk'>
  <pre style="background:#211e1e;color:#f8f8f8">styleUrls <span style="color:#e28964">=</span> scrapeStyleUrls(<span style="color:#65b042"><span style="color:#99cf50">r</span>'http://beersmithrecipes<span style="color:#ddf2a4">.</span>com/styles'</span>)

recipeurls <span style="color:#e28964">=</span> []
<span style="color:#e28964">for</span> url <span style="color:#e28964">in</span> styleUrls:
    scrapeRecipeUrls(url)

recipeList <span style="color:#e28964">=</span> []
ingredientList <span style="color:#e28964">=</span> []
<span style="color:#e28964">for</span> url <span style="color:#e28964">in</span> recipeurls:
    <span style="color:#e28964">try</span>:
        recDict,ingList <span style="color:#e28964">=</span> scrapeRecipe(url)
        recipeList.append(recDict)
        <span style="color:#e28964">for</span> ingDict <span style="color:#e28964">in</span> ingList:
            ingredientList.append(ingDict)
    <span style="color:#e28964">except</span>:
        <span style="color:#e28964">pass</span></pre>
        </div>
        <div class = 'text-input-box'>
          <h2><b>Recipe Collection Analysis</b></h2>
          <p>The scraper was able to collect 30,267 recipes in total, each with 19 different attributes.
            After breifly scanning the dataset I found a couple of things that needed to be addressed before moving on with the analysis.
            First, the scraper picked up a handful of duplicate recipes that need to be removed. Second, the values of some variables
            lead me to beleive that a few of the recipes in this dataset are bogus. This makes sense because the recipes are user
            submitted and I'm fairly certain that BeerSmith does not maintain a strict review/approval process for their database.
            Discovering this also seemed like a pefect time to pare down the dataset to the variables that I'm truly interested in.
            I settled on four primary variables of interest that could also help me weed out unrealistic recipes.</p>
            <ol style = 'font-size: .95rem;'>
              <li><b>ABV</b> - Alcohol by volume expressed as a percentage. Realistic values fall between 2% and 30%.</li>
              <li><b>Bitterness</b> - Expressed in international bitterness units (IBU's). Realistic values fall between 0 and 150.</li>
              <li><b>Color</b> - Expressed via the standard reference method (SRM). Realistic values fall between 0 and 100.</li>
              <li><b>Style Master</b> - Generalized beer style of the recipe.
            </ol>
            <p>
              ABV, color and bitterness values in the dataset contain some unwanted text so
              below I'll clean them up, convert them to numeric, and filter out records that do not meet the criteria above.
            </p>
        </div>
        <div class = 'code-chunk'>
<pre style="background:#211e1e;color:#dadada">library(<span style="color:#c1c144">dplyr</span>)

<span style="color:#c1c144">recipes</span> <span style="color:#47b8d6">&lt;-</span> read.csv(<span style="color:#ad9361">"data/bsrecipes.csv"</span>)

<span style="color:#555"># clean and select fields of interest</span>
<span style="color:#c1c144">recipes</span> <span style="color:#47b8d6">&lt;-</span> <span style="color:#c1c144">recipes</span> %<span style="color:#47b8d6">></span>%
  group_by(<span style="color:#c1c144">Rec_ID</span>) %<span style="color:#47b8d6">></span>%
  filter(row_number() <span style="color:#47b8d6">=</span><span style="color:#47b8d6">=</span> <span style="color:#ccc">1</span>) %<span style="color:#47b8d6">></span>%
  ungroup() %<span style="color:#47b8d6">></span>%
  mutate(<span style="color:#c1c144">ABV_pct</span> <span style="color:#47b8d6">=</span> as.numeric(gsub(<span style="color:#ad9361">"%"</span>,<span style="color:#ad9361">""</span>,<span style="color:#c1c144">ABV</span>)),
         <span style="color:#c1c144">Bitterness_ibu</span> <span style="color:#47b8d6">=</span> as.numeric(gsub(<span style="color:#ad9361">" IBUs"</span>,<span style="color:#ad9361">""</span>,<span style="color:#c1c144">Bitterness</span>)),
         <span style="color:#c1c144">Color_srm</span> <span style="color:#47b8d6">=</span> as.numeric(gsub(<span style="color:#ad9361">" SRM"</span>,<span style="color:#ad9361">""</span>,<span style="color:#c1c144">Color</span>))) %<span style="color:#47b8d6">></span>%
  select(<span style="color:#c1c144">ABV_pct</span>, <span style="color:#c1c144">Bitterness_ibu</span>, <span style="color:#c1c144">Color_srm</span>, <span style="color:#c1c144">Style_Master</span>, <span style="color:#c1c144">Rec_Type</span> <span style="color:#47b8d6">=</span> <span style="color:#c1c144">Type</span>)

<span style="color:#555"># remove unrealistic recipes</span>
<span style="color:#c1c144">recipes</span> <span style="color:#47b8d6">&lt;-</span> <span style="color:#c1c144">recipes</span> %<span style="color:#47b8d6">></span>%
  filter(<span style="color:#c1c144">ABV_pct</span> <span style="color:#47b8d6">></span><span style="color:#47b8d6">=</span> <span style="color:#ccc">2</span> <span style="color:#47b8d6">&amp;</span> <span style="color:#c1c144">ABV_pct</span> <span style="color:#47b8d6">&lt;</span><span style="color:#47b8d6">=</span> <span style="color:#ccc">25</span>,
         <span style="color:#c1c144">Bitterness_ibu</span> <span style="color:#47b8d6">></span> <span style="color:#ccc">0</span> <span style="color:#47b8d6">&amp;</span> <span style="color:#c1c144">Bitterness_ibu</span> <span style="color:#47b8d6">&lt;</span><span style="color:#47b8d6">=</span> <span style="color:#ccc">150</span>,
         <span style="color:#c1c144">Color_srm</span> <span style="color:#47b8d6">&lt;</span> <span style="color:#ccc">100</span>)
</pre>
        </div>
        <div class = 'text-input-box'>
          <p>After cleaning we are down to a final count of 26,578 recipes. Now let's find out which styles are the most popular.
            I'll utilize SRM values to color my visualizations so I've mapped some approximate hex values that I grabbed from
            <a target="_blank" href = 'http://www.twobeerdudes.com/beer/srm'>here</a> to my dataset. The plotting code isn't shown below but
            can be viewed on <a target = '_blank' href = 'https://github.com/jdubx2/website/blob/master/recipes/beersmith%20recipes.R'>github</a>.</p>
        </div>
        <div class = 'img_box'>
          <img class = 'img_box_img' src = 'img/recipe_bar.svg'>
        </div>
        <div class = 'text-input-box'>
          <p>It seems that IPA's are the overwhelming favorite on beersmith and it's interesting to note that 13 styles account
            for 85% of all recipes in the database. Even though beers with mid-range SRM's are the most popular (thanks to IPA's
            and pale ales), there still seems to be plenty of love for dark beers with stouts and porters taking third and fifth place respectively.</p>
            <p>Now let's take a look at preferences related to alchol level and bitterness by creating a scatterplot. We'll plot all of the recipes as points and
              overlay aggregate measurments for popular stlyes (> 200 recipes) as rectangular labels to see where each falls on average.</p>
        </div>
        <div class = 'img_box'>
          <img class = 'img_box_img' src = 'img/recipe_scatter.png'>
        </div>
        <div class = 'text-input-box'>
          <p>An interesting spread. Light beers like pilsners and kolsches are expectedly tame and have a
            fairly limited range of both bitterness and alcohol content. Dark beers seem to have the most
            variation in alcohol content while beers with mid range SRM's come in a wide variety of
            bitterness levels. All in all, the sweet spot for this corpus seems to be around 3%-9% ABV with 15-45 IBU's.
          </p>
          <h2><b>Visualizing the Ingredients</b></h2>
          <p>I explored a number of options for digging into the ingredients portion of this dataset and concluded that network diagrams
            would be a great way to see which ingredients are the most popular while also getting an idea of how they are typically used together.
          </p>
          <p>
            In order to build a network visualization for each style of beer, I need to transform the ingredients of each recipe
            into a dataset of nodes and edges. Each node will be an ingredient, and I want the size of the node to correspond with how often the ingredient
            appears in the recipe corpus. The size & charge of the edges between nodes will then correspond to the frequency with which two
            ingredients appear together. In order to count these appearances, I'll increment the value of an edge by one each time two ingredients are used together.
            For example, a recipe with three ingredients would have three pairs counted - (ingredient 1, ingredient 2) / (ingredient 1, ingredient 3) / (ingredient 2, ingredient 3).</p>
            <p>The final output needs to be a json object that I can feed to the D3 powered visualization I'll be building.
            The commented code chunk below shows the process of converting the raw csv files into a json object with R.</p>
          </p>
        </div>
        <div class = 'code-chunk'>
<pre style="background:#211e1e;color:#dadada">library(<span style="color:#c1c144">dplyr</span>)
library(<span style="color:#c1c144">tidyr</span>)

<span style="color:#c1c144">ingredients</span> <span style="color:#47b8d6">&lt;-</span> read.csv(<span style="color:#ad9361">"data/bsingredients.csv"</span>, <span style="color:#c1c144">stringsAsFactors</span> <span style="color:#47b8d6">=</span> <span style="color:#de8e30;font-weight:700">F</span>)
<span style="color:#c1c144">recipes</span> <span style="color:#47b8d6">&lt;-</span> read.csv(<span style="color:#ad9361">"data/bsrecipes.csv"</span>, <span style="color:#c1c144">stringsAsFactors</span> <span style="color:#47b8d6">=</span> <span style="color:#de8e30;font-weight:700">F</span>)

<span style="color:#555">### Remove duplicates / select cols for join</span>
<span style="color:#c1c144">recipes</span> <span style="color:#47b8d6">&lt;-</span> <span style="color:#c1c144">recipes</span> %<span style="color:#47b8d6">></span>%
  group_by(<span style="color:#c1c144">Rec_ID</span>) %<span style="color:#47b8d6">></span>%
  filter(row_number() <span style="color:#47b8d6">=</span><span style="color:#47b8d6">=</span> <span style="color:#ccc">1</span>) %<span style="color:#47b8d6">></span>%
  select(<span style="color:#c1c144">Rec_ID</span>, <span style="color:#c1c144">Style_Master</span>)


<span style="color:#555">### Join style_master to ingredients, fix names</span>
<span style="color:#c1c144">ingredients</span> <span style="color:#47b8d6">&lt;-</span> <span style="color:#c1c144">ingredients</span> %<span style="color:#47b8d6">></span>%
  left_join(<span style="color:#c1c144">recipes</span>, <span style="color:#c1c144">by</span> <span style="color:#47b8d6">=</span> <span style="color:#ad9361">'Rec_ID'</span>) %<span style="color:#47b8d6">></span>%
  filter(<span style="color:#47b8d6">!</span>(is.na(<span style="color:#c1c144">Style_Master</span>))) %<span style="color:#47b8d6">></span>%
  select(<span style="color:#c1c144">ing_type</span> <span style="color:#47b8d6">=</span> <span style="color:#c1c144">Ing_Type</span>, <span style="color:#c1c144">ing</span> <span style="color:#47b8d6">=</span> <span style="color:#c1c144">Ingredient</span>, <span style="color:#c1c144">ing_simple</span> <span style="color:#47b8d6">=</span> <span style="color:#c1c144">Ingredient_simple</span>,
         <span style="color:#c1c144">rec_id</span> <span style="color:#47b8d6">=</span> <span style="color:#c1c144">Rec_ID</span>, <span style="color:#c1c144">style</span> <span style="color:#47b8d6">=</span> <span style="color:#c1c144">Style_Master</span>)

<span style="color:#555">### imported style_df dataframe from beersmith_recipes.r to filter out frequent styles</span>
<span style="color:#c1c144">style_df</span> <span style="color:#47b8d6">&lt;-</span> <span style="color:#c1c144">style_df</span> %<span style="color:#47b8d6">></span>%
  arrange(desc(<span style="color:#c1c144">count</span>)) %<span style="color:#47b8d6">></span>% slice(<span style="color:#ccc">1</span><span style="color:#a1a1ff">:</span><span style="color:#ccc">15</span>) %<span style="color:#47b8d6">></span>% select(<span style="color:#c1c144">Style_Master</span>)

<span style="color:#555">### join style_df table to filter out low volume styles</span>
<span style="color:#555">### remove combos with less than 20 appearances to prune nodes &amp; filter some edge cases</span>
<span style="color:#c1c144">ingredient_nodes</span> <span style="color:#47b8d6">&lt;-</span> <span style="color:#c1c144">ingredients</span> %<span style="color:#47b8d6">></span>%
  group_by(<span style="color:#c1c144">ing_simple</span>, <span style="color:#c1c144">ing_type</span>, <span style="color:#c1c144">style</span>) %<span style="color:#47b8d6">></span>%
  filter(<span style="color:#c1c144">ing_type</span> <span style="color:#47b8d6">%in%</span> c(<span style="color:#ad9361">"Grain"</span>,<span style="color:#ad9361">"Hops"</span>,<span style="color:#ad9361">"Yeast"</span>)) %<span style="color:#47b8d6">></span>%
  summarise(<span style="color:#c1c144">count</span> <span style="color:#47b8d6">=</span> n()) %<span style="color:#47b8d6">></span>%
  inner_join(<span style="color:#c1c144">style_df</span>, <span style="color:#c1c144">by</span> <span style="color:#47b8d6">=</span> c(<span style="color:#ad9361">'style'</span> <span style="color:#47b8d6">=</span> <span style="color:#ad9361">'Style_Master'</span>)) %<span style="color:#47b8d6">></span>%
  arrange(desc(<span style="color:#c1c144">count</span>)) %<span style="color:#47b8d6">></span>%
  filter(<span style="color:#c1c144">count</span> <span style="color:#47b8d6">></span> <span style="color:#ccc">20</span>,
         <span style="color:#c1c144">ing_simple</span> <span style="color:#47b8d6">!=</span> <span style="color:#ad9361">"None"</span>,
         <span style="color:#47b8d6">!</span>(<span style="color:#c1c144">ing_simple</span> <span style="color:#47b8d6">=</span><span style="color:#47b8d6">=</span> <span style="color:#ad9361">"Brewer"</span> <span style="color:#47b8d6">&amp;</span> <span style="color:#c1c144">ing_type</span> <span style="color:#47b8d6">=</span><span style="color:#47b8d6">=</span> <span style="color:#ad9361">"Grain"</span>),
         <span style="color:#47b8d6">!</span>(<span style="color:#c1c144">ing_simple</span> <span style="color:#47b8d6">=</span><span style="color:#47b8d6">=</span> <span style="color:#ad9361">"Crystal"</span> <span style="color:#47b8d6">&amp;</span> <span style="color:#c1c144">ing_type</span> <span style="color:#47b8d6">=</span><span style="color:#47b8d6">=</span> <span style="color:#ad9361">"Grain"</span>))

<span style="color:#555">### Manual cleanup in excel to merge simmilar nodes</span>
<span style="color:#555"># in_cleanup &lt;- ingredient_nodes %>%</span>
<span style="color:#555">#   group_by(ing_simple, ing_type) %>%</span>
<span style="color:#555">#   summarise()</span>
<span style="color:#555">#</span>
<span style="color:#555"># write.csv(in_cleanup, 'in_cleanup.csv', row.names = F)</span>
<span style="color:#c1c144">in_cleanup</span> <span style="color:#47b8d6">&lt;-</span> read.csv(<span style="color:#ad9361">'data/in_cleanup.csv'</span>, <span style="color:#c1c144">stringsAsFactors</span> <span style="color:#47b8d6">=</span> <span style="color:#de8e30;font-weight:700">F</span>)

<span style="color:#555">### join cleaned ingredient column, recalc the count, spread to table format by style</span>
<span style="color:#c1c144">ingredient_nodes</span> <span style="color:#47b8d6">&lt;-</span> <span style="color:#c1c144">ingredient_nodes</span> %<span style="color:#47b8d6">></span>%
  left_join(<span style="color:#c1c144">in_cleanup</span>, <span style="color:#c1c144">by</span> <span style="color:#47b8d6">=</span> c(<span style="color:#ad9361">'ing_simple'</span>,<span style="color:#ad9361">'ing_type'</span>)) %<span style="color:#47b8d6">></span>%
  filter(<span style="color:#c1c144">ing_final</span> <span style="color:#47b8d6">!=</span> <span style="color:#ad9361">''</span>) %<span style="color:#47b8d6">></span>%
  group_by(<span style="color:#c1c144">ing_final</span>, <span style="color:#c1c144">ing_type</span>, <span style="color:#c1c144">style</span>) %<span style="color:#47b8d6">></span>%
  summarise(<span style="color:#c1c144">count</span> <span style="color:#47b8d6">=</span> sum(<span style="color:#c1c144">count</span>))

<span style="color:#555">### check for overallping names regardless of ing_type</span>
<span style="color:#c1c144">ingredient_nodes</span> %<span style="color:#47b8d6">></span>% group_by(<span style="color:#c1c144">ing_final</span>) %<span style="color:#47b8d6">></span>% summarise(<span style="color:#c1c144">count</span> <span style="color:#47b8d6">=</span> n()) %<span style="color:#47b8d6">></span>% arrange(desc(<span style="color:#c1c144">count</span>))

<span style="color:#555">### filter out ingredient/style combinations not in node list + add ing_final</span>
<span style="color:#c1c144">pre_edge_df</span> <span style="color:#47b8d6">&lt;-</span> <span style="color:#c1c144">ingredients</span> %<span style="color:#47b8d6">></span>%
  inner_join(<span style="color:#c1c144">in_cleanup</span>, <span style="color:#c1c144">by</span> <span style="color:#47b8d6">=</span> c(<span style="color:#ad9361">'ing_simple'</span>,<span style="color:#ad9361">'ing_type'</span>)) %<span style="color:#47b8d6">></span>%
  filter(<span style="color:#c1c144">ing_final</span> <span style="color:#47b8d6">!=</span> <span style="color:#ad9361">''</span>) %<span style="color:#47b8d6">></span>%
  inner_join(<span style="color:#c1c144">ingredient_nodes</span>, <span style="color:#c1c144">by</span> <span style="color:#47b8d6">=</span> c(<span style="color:#ad9361">'ing_final'</span>,<span style="color:#ad9361">'style'</span>)) %<span style="color:#47b8d6">></span>%
  select(<span style="color:#c1c144">ing_final</span>, <span style="color:#c1c144">rec_id</span>, <span style="color:#c1c144">style</span>) %<span style="color:#47b8d6">></span>%
  group_by(<span style="color:#c1c144">ing_final</span>, <span style="color:#c1c144">rec_id</span>, <span style="color:#c1c144">style</span>) %<span style="color:#47b8d6">></span>%
  summarise() %<span style="color:#47b8d6">></span>%
  arrange(<span style="color:#c1c144">rec_id</span>,<span style="color:#c1c144">ing_final</span>)

<span style="color:#555">### DPLYR Filter too slow (3.6 sec per recipe) create min/max indexing of recipes instead</span>
<span style="color:#c1c144">rec_index_df</span><span style="color:#47b8d6">&lt;-</span> <span style="color:#c1c144">pre_edge_df</span> %<span style="color:#47b8d6">></span>%
  ungroup() %<span style="color:#47b8d6">></span>%
  mutate(<span style="color:#c1c144">row_num</span> <span style="color:#47b8d6">=</span> row_number()) %<span style="color:#47b8d6">></span>%
  group_by(<span style="color:#c1c144">rec_id</span>) %<span style="color:#47b8d6">></span>%
  mutate(<span style="color:#c1c144">min_row</span> <span style="color:#47b8d6">=</span> min(<span style="color:#c1c144">row_num</span>),
         <span style="color:#c1c144">max_row</span> <span style="color:#47b8d6">=</span> max(<span style="color:#c1c144">row_num</span>)) %<span style="color:#47b8d6">></span>%
  group_by(<span style="color:#c1c144">rec_id</span>, <span style="color:#c1c144">min_row</span>, <span style="color:#c1c144">max_row</span>) %<span style="color:#47b8d6">></span>%
  summarise()

<span style="color:#555">### Function for getting combo dataframes and adding to final list</span>
get_combos <span style="color:#47b8d6">&lt;-</span> <span style="color:#6969fa;font-weight:700">function</span>(<span style="color:#c1c144">min_idx</span>, <span style="color:#c1c144">max_idx</span>) {

      <span style="color:#c1c144">filtered</span> <span style="color:#47b8d6">&lt;-</span> <span style="color:#c1c144">pre_edge_df</span>[<span style="color:#c1c144">min_idx</span><span style="color:#a1a1ff">:</span><span style="color:#c1c144">max_idx</span>,]
      <span style="color:#c1c144">rec_style</span> <span style="color:#47b8d6">=</span> unique(<span style="color:#c1c144">filtered</span><span style="color:#a1a1ff">$</span><span style="color:#c1c144">style</span>)

      <span style="color:#c1c144">combo_matrix</span> <span style="color:#47b8d6">&lt;-</span> combn(<span style="color:#c1c144">filtered</span><span style="color:#a1a1ff">$</span><span style="color:#c1c144">ing_final</span>, <span style="color:#ccc">2</span>)

      <span style="color:#c1c144">combo_df</span> <span style="color:#47b8d6">&lt;-</span> as.data.frame(t(<span style="color:#c1c144">combo_matrix</span>), <span style="color:#c1c144">stringsAsFactors</span> <span style="color:#47b8d6">=</span> <span style="color:#de8e30;font-weight:700">F</span>) %<span style="color:#47b8d6">></span>%
        mutate(<span style="color:#c1c144">style</span> <span style="color:#47b8d6">=</span> <span style="color:#c1c144">rec_style</span>)

      <span style="color:#6969fa;font-weight:700">return</span>(<span style="color:#c1c144">combo_df</span>)
}
<span style="color:#555">### Itterate through each rec min/max in rec_index_df and get combos</span>
<span style="color:#555">### add combos to final list and concatenate</span>
<span style="color:#c1c144">combo_list</span> <span style="color:#47b8d6">&lt;-</span> list()
<span style="color:#c1c144">i</span> <span style="color:#47b8d6">=</span> <span style="color:#ccc">1</span>

<span style="color:#6969fa;font-weight:700">for</span>(<span style="color:#c1c144">row_idx</span> <span style="color:#6969fa;font-weight:700">in</span> seq_len(nrow(<span style="color:#c1c144">rec_index_df</span>))){

  <span style="color:#c1c144">min</span> <span style="color:#47b8d6">&lt;-</span> as.numeric(<span style="color:#c1c144">rec_index_df</span>[<span style="color:#c1c144">row_idx</span>, <span style="color:#ccc">2</span>])
  <span style="color:#c1c144">max</span> <span style="color:#47b8d6">&lt;-</span> as.numeric(<span style="color:#c1c144">rec_index_df</span>[<span style="color:#c1c144">row_idx</span>, <span style="color:#ccc">3</span>])

  <span style="color:#6969fa;font-weight:700">if</span>(<span style="color:#c1c144">max</span> <span style="color:#47b8d6">></span> <span style="color:#c1c144">min</span>){
    <span style="color:#c1c144">combo_list</span>[[<span style="color:#c1c144">i</span>]] <span style="color:#47b8d6">&lt;-</span> get_combos(<span style="color:#c1c144">min</span>,<span style="color:#c1c144">max</span>)
    <span style="color:#c1c144">i</span> <span style="color:#47b8d6">&lt;-</span> <span style="color:#c1c144">i</span> <span style="color:#47b8d6">+</span> <span style="color:#ccc">1</span>
    }
}
<span style="color:#c1c144">combo_df_final</span> <span style="color:#47b8d6">&lt;-</span> bind_rows(<span style="color:#c1c144">combo_list</span>)

<span style="color:#c1c144">ingredient_edges</span> <span style="color:#47b8d6">&lt;-</span> <span style="color:#c1c144">combo_df_final</span> %<span style="color:#47b8d6">></span>%
  group_by(<span style="color:#c1c144">V1</span>, <span style="color:#c1c144">V2</span>, <span style="color:#c1c144">style</span>) %<span style="color:#47b8d6">></span>%
  summarise(<span style="color:#c1c144">count</span> <span style="color:#47b8d6">=</span> n())

saveRDS(<span style="color:#c1c144">ingredient_nodes</span>, <span style="color:#ad9361">'data/ingredient_nodes.rds'</span>)
saveRDS(<span style="color:#c1c144">ingredient_edges</span>, <span style="color:#ad9361">'data/ingredient_edges.rds'</span>)

<span style="color:#555"># ### Nodes and edges complete ###</span>

library(<span style="color:#c1c144">jsonlite</span>)
<span style="color:#555">#Example of how to create a json object to feed the forece simulation</span>
  write_json(list(<span style="color:#c1c144">nodes</span> <span style="color:#47b8d6">=</span> filter(<span style="color:#c1c144">ingredient_nodes</span>, <span style="color:#c1c144">style</span> <span style="color:#47b8d6">=</span><span style="color:#47b8d6">=</span> <span style="color:#ad9361">'Porter'</span>),
                  <span style="color:#c1c144">links</span> <span style="color:#47b8d6">=</span> filter(<span style="color:#c1c144">ingredient_edges</span>, <span style="color:#c1c144">style</span> <span style="color:#47b8d6">=</span><span style="color:#47b8d6">=</span> <span style="color:#ad9361">'Porter'</span>)), <span style="color:#ad9361">'data/porter.json'</span>)

</pre>
        </div>
        <div class = 'text-input-box'>
          <p>
            The network visualization below was created using R shiny and D3.js. Shiny passes json objects of nodes and edges
            to D3 and a force simlation is created in the browser. The repo for this visualization can be found on <a target = '_blank' href = 'https://github.com/jdubx2/ingredient_network'>github</a>
            and a full screen version can be viewed <a target = '_blank' href ="http://www.quickviz.live/shiny/ingredient_network">here</a>.
          </p>
        </div>
        <div class = 'img_box'>
          <iframe class = 'network_iframe' src="http://www.quickviz.live/shiny/ingredient_network" width = '100%' overflow = "hidden" scrolling="no"></iframe>
        </div>
    </div>
    </div>
    <!-- /.container -->

    <!-- Footer -->
    <footer class="py-5 bg-dark">
      <div class="container">
        <p class="m-0 text-center text-white">&copy; 2018 jesseweiss.me</p>
      </div>
      <!-- /.container -->
    </footer>

    <!-- Bootstrap core JavaScript -->
    <script src="vendor/jquery/jquery.min.js"></script>
    <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

    <script src="vendor/bootstrap/js/newjs.js"></script>

    <script type="text/javascript" language="javascript">
    $('.network_iframe').css('height', $(window).height() * .8 +'px');
    </script>

  </body>

</html>
